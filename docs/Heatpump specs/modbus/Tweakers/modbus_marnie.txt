esphome:
  name: modbus
  friendly_name: Modbus

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    advanced:
      minimum_chip_revision: "3.1"

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "je sleutel"

ota:
  - platform: esphome
    password: "je wachtwoord"

wifi:
  min_auth_mode: WPA2
  networks:
  - ssid: !secret wifi_ssid
    password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Modbus Fallback Hotspot"
    password: "je wachtwoord"

# Example configuration entry
time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Amsterdam
    servers:
     - 0.pool.ntp.org
     - 1.pool.ntp.org
     - 2.pool.ntp.org

captive_portal:

web_server:
  port: 80
  version: 3
  local: True
  include_internal: True
  auth:
    username: !secret web_server_username
    password: !secret web_server_password

# Adlar modbus
uart:
  - id: uart_modbus
    tx_pin: GPIO17
    rx_pin: GPIO16
    baud_rate: 9600
    data_bits: 8
    stop_bits: 1
    parity: NONE

modbus:
  - uart_id: uart_modbus
    id: modbus_client

modbus_controller:
  - id: modbus_adlar
    modbus_id: modbus_client
    address: 0x01
    update_interval: 60s

globals: 
  - id: compressor_minuten
    type: int
    restore_value: true
    initial_value: "0"

number:
  - platform: template
    name: "Compressor uren offset"
    id: offset_uren
    max_value: 99999999
    min_value: -99999999
    step: 1
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 0
    disabled_by_default: true


  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P26 Hysterese watertemperatuur start warmtepomp"
    register_type: holding
    address: 0x011A
    device_class: temperature
    value_type: S_WORD
    max_value: 10
    min_value: 0
    step: 1
    mode: box
    unit_of_measurement: °C
    disabled_by_default: true

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P88 Silent mode - compressor maximum frequency"
    register_type: holding
    address: 0x0158
    device_class: frequency
    value_type: S_WORD
    max_value: 70
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: Hz
    disabled_by_default: true  
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Silent mode - fan motor maximum frequency"
    register_type: holding
    address: 0x0159
    device_class: frequency
    value_type: S_WORD
    max_value: 60
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: Hz
    disabled_by_default: true

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P99 Water pump speed regulation temperature differential"
    register_type: holding
    address: 0x0163
    device_class: temperature
    value_type: S_WORD
    max_value: 10
    min_value: 2
    step: 1
    mode: box
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P100 PWM pump minimum speed"
    register_type: holding
    address: 0x0164
    device_class: frequency
    value_type: S_WORD
    max_value: 80
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: "%" 
    disabled_by_default: true

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P163 Water pump speed regulation - Minimum speed"
    register_type: holding
    address: 0x01A3
    device_class: volume_flow_rate
    value_type: S_WORD
    max_value: 70
    min_value: 0
    step: 1
    mode: box
    unit_of_measurement: L/min
    disabled_by_default: true

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P260 Maximum water pump speed"
    register_type: holding
    address: 0x0204
    device_class: frequency
    value_type: S_WORD
    max_value: 99
    min_value: 50
    step: 1
    mode: box
    unit_of_measurement: "%" 
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "P261 Water pump speed - at constant temperature"
    register_type: holding
    address: 0x0205
    device_class: frequency
    value_type: S_WORD
    max_value: 99
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: "%" 
    disabled_by_default: true

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Temp. Set-Cooling"
    register_type: holding
    address: 0x0300
    device_class: temperature
    value_type: S_WORD
    max_value: 25
    min_value: 7
    step: 1
    mode: box
    unit_of_measurement: °C
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Temp. Set-Heating"
    register_type: holding
    address: 0x0301
    device_class: temperature
    value_type: S_WORD
    max_value: 60
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: °C

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Temp. Set-Floor Heating"
    register_type: holding
    address: 0x0303
    device_class: temperature
    value_type: S_WORD
    max_value: 60
    min_value: 20
    step: 1
    mode: box
    unit_of_measurement: °C
    disabled_by_default: true


switch:
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Main switch"
    register_type: holding
    address: 0x0305

select:
  - platform: modbus_controller
    name: "MODE"
    address: 0x0304
    value_type: U_WORD
    optionsmap: 
      "Cooling": 0
      "Heating": 1
      "Floor Heating": 3

  - platform: modbus_controller
    name: "Running Mode"
    address: 0x0307
    value_type: U_WORD
    optionsmap: 
      "Standard": 0
      "Boost": 1
      "Silent": 2

  - platform: modbus_controller
    name: "Cooling Setting Curve"
    address: 0x0313
    value_type: U_WORD
    optionsmap: 
      "Off": 0
      "H1": 1
      "H2": 2
      "H3": 3
      "H4": 4
      "H5": 5
      "H6": 6
      "H7": 7
      "H8": 8
      "L1": 11
      "L2": 12
      "L3": 13
      "L4": 14
      "L5": 15
      "L6": 16
      "L7": 17
      "L8": 18
  - platform: modbus_controller
    name: "Heating Setting Curve"
    address: 0x0314
    value_type: U_WORD
    optionsmap: 
      "Off": 0
      "H1": 1
      "H2": 2
      "H3": 3
      "H4": 4
      "H5": 5
      "H6": 6
      "H7": 7
      "H8": 8
      "L1": 11
      "L2": 12
      "L3": 13
      "L4": 14
      "L5": 15
      "L6": 16
      "L7": 17
      "L8": 18

  - platform: modbus_controller
    name: "Underfloor Heating Setting Curve"
    address: 0x0316
    value_type: U_WORD
    optionsmap: 
      "Off": 0
      "H1": 1
      "H2": 2
      "H3": 3
      "H4": 4
      "H5": 5
      "H6": 6
      "H7": 7
      "H8": 8
      "L1": 11
      "L2": 12
      "L3": 13
      "L4": 14
      "L5": 15
      "L6": 16
      "L7": 17
      "L8": 18
    disabled_by_default: true 

binary_sensor:
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x01
    name: "Refrigerant Recovery"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x2
    name: "Primary Anti-freeze"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x4
    name: "Secondary Anti-freeze"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x8
    name: "Fault Alarm"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x010
    name: "System oil return"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x0100
    name: "System Frosting"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x01000
    name: "Shutdown after Reaching Temp"
    id: compressor_active
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x2000
    name: "Shutdown after Unit Failure"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000    
    register_type: holding
    bitmask: 0x4000
    name: "Unit Operation"
    disabled_by_default: true 
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    address: 0x0000
    register_type: holding
    bitmask: 0x8000
    name: "Unit Waiting for Operation"
    disabled_by_default: true 
    
sensor:
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Compressor Target Frequency"
    register_type: holding
    address: 0x0027
    device_class: frequency
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: Hz
    disabled_by_default: true
#    register_count: 25 # sla aantal registers over en ga direct naar 0x0040

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Compressor Running Frequency"
    register_type: holding
    address: 0x0040
    device_class: frequency
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: Hz
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Fan Running Speed"
    register_type: holding
    address: 0x0041
    device_class: frequency
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: Hz
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "EEV Open Step"
    register_type: holding
    address: 0x0042
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: P
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "EVI Valve Open Step"
    register_type: holding
    address: 0x0043
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: P
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "AC Input Voltage"
    id: voltage
    register_type: holding
    address: 0x0044
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: voltage
    unit_of_measurement: V
    filters:
      - multiply: 0.99
      - heartbeat:
          period: 60s
          optimistic: true
      - median:
          window_size: 5
          send_every: 5
          send_first_at: 1
  # - platform: modbus_controller
  #   modbus_controller_id: modbus_adlar
  #   name: "AC Input Current raw"
  #   id: current_raw
  #   register_type: holding
  #   address: 0x0045
  #   value_type: S_WORD
  #   accuracy_decimals: 1
  #   device_class: current
  #   unit_of_measurement: A
  #   filters:
  #     - heartbeat:
  #         period: 60s
  #         optimistic: true
  #     - multiply: 0.1
    
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "AC Input Current"
    id: current
    register_type: holding
    address: 0x0045
    value_type: S_WORD
    accuracy_decimals: 1
    device_class: current
    unit_of_measurement: A
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
      - multiply: 0.1
      - calibrate_linear:
          method: exact
          datapoints:
           # Map 0.0 (from sensor) to 0.0 (true value)
           - 0.0 -> 0.0
           - 1.0 -> 1.0 #?
           - 2.0 -> 2.0 #?
           - 3.0 -> 2.5 #?
           - 4.0 -> 2.9
           - 5.0 -> 3.4
           - 6.0 -> 4.6 #?
           - 7.0 -> 5.5 #5.9?
           - 8.0 -> 6.8 #6.4?
           - 9.0 -> 7.8 
           - 10.0 -> 8.5
           - 11.0 -> 9.0
      - median:
          window_size: 5
          send_every: 5
          send_first_at: 1

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Compressor Phase Current"
    register_type: holding
    address: 0x0046
    value_type: S_WORD
    accuracy_decimals: 1
    device_class: current
    unit_of_measurement: A
    filters:
      - multiply: 0.1
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Compressor IPM Temp."
    register_type: holding
    address: 0x0047
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "High Pressure Saturation Temp."
    register_type: holding
    address: 0x0048
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Low  Pressure Saturation Temp."
    register_type: holding
    address: 0x0049
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Ambient Temp. T1"
    register_type: holding
    address: 0x004A
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
      - filter_out: NAN
      - median:
          window_size: 5
          send_every: 5
          send_first_at: 1
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Outer Coil Temp. T2"
    register_type: holding
    address: 0x004B
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Inner Coil Temp. T3"
    register_type: holding
    address: 0x004C
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Suction Temp. T4"
    register_type: holding
    address: 0x004D
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Exhaust Temp. T5"
    register_type: holding
    address: 0x004E
    value_type: S_WORD
    accuracy_decimals: 0
    device_class: temperature
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Water Inlet Temp. T6"
    id: temp_inlet
    register_type: holding
    address: 0x004F
    device_class: temperature
    value_type: S_WORD
    accuracy_decimals: 1
    unit_of_measurement: °C
    filters:
      - heartbeat:
          period: 60s
          optimistic: true  
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Water Outlet Temp. T7"
    id: temp_outlet
    register_type: holding
    address: 0x0050
    device_class: temperature
    value_type: S_WORD
    accuracy_decimals: 1
    unit_of_measurement: °C
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Economizer Inlet Temp. T8"
    register_type: holding
    address: 0x0051
    device_class: temperature
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: °C
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Economizer Outlet Temp. T9"
    register_type: holding
    address: 0x0052
    device_class: temperature
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: °C
    disabled_by_default: true
#    register_count: 3 # sla aantal registers over en ga direct naar 0x0055

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Plate Heat Exchanger Exhaust Temp."
    register_type: holding
    address: 0x0055
    device_class: temperature
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: °C
    disabled_by_default: true
#    register_count: 2 # sla aantal registers over en ga direct naar 0x0057

  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Water Pump Speed PWM"
    register_type: holding
    address: 0x0057
    device_class: frequency
    value_type: S_WORD
    accuracy_decimals: 0
    unit_of_measurement: Hz
    disabled_by_default: true
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Water Flow"
    register_type: holding
    address: 0x0058
    device_class: volume_flow_rate
    value_type: S_WORD
    accuracy_decimals: 0
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
      - filter_out: NAN
    unit_of_measurement: L/min
  - platform: modbus_controller
    modbus_controller_id: modbus_adlar
    name: "Water Flow median"
    id: flow_median
    register_type: holding
    address: 0x0058
    device_class: volume_flow_rate
    value_type: S_WORD
    accuracy_decimals: 0
    filters:
      - heartbeat:
          period: 60s
          optimistic: true
      - filter_out: NAN
      - median:
          window_size: 5
          send_every: 5
          send_first_at: 1
    unit_of_measurement: L/min
#    internal: true

  - platform: template
    name: "AC Input Power"
    id: power_in
    lambda: return id(voltage).state * id(current).state;
    accuracy_decimals: 0
    filters:
      - clamp:
          min_value: 0
          max_value: 2000
          ignore_out_of_range: true
      - filter_out: NAN
    unit_of_measurement: "W"
    device_class: power
  - platform: template
    name: "Thermal Output Power"
    id: power_out
    filters:
      - clamp:
          min_value: 0
          max_value: 10000
          ignore_out_of_range: true
#      - filter_out: NAN
    lambda: |-
      const float smw = 0.998;  // soortelijke massa water
      const float sww = 4186;   // soortelijke warmte water
      return (id(flow_median).state / 1000 / 60) * smw * sww * (id(temp_outlet).state - id(temp_inlet).state) * 1000;
    accuracy_decimals: 0
    unit_of_measurement: "W"
    device_class: power
  - platform: template
    name: "COP"
    id: cop
    filters:
      - clamp:
          min_value: 0
          max_value: 10
          ignore_out_of_range: true
      - filter_out: NAN
      - median
    lambda: return id(power_out).state / id(power_in).state;
    accuracy_decimals: 1
    unit_of_measurement: ""
    state_class: measurement
#      - lambda: if (isnan(x)) {  return 0; } return x; 
text_sensor:
  - platform: template
    name: "Compressor uren"
#    id: compressor_uren
#    unit_of_measurement: "uren"
#    accuracy_decimals: 0
    device_class: "" 
    icon: "mdi:timer-outline"
    update_interval: 60s
    disabled_by_default: true
    lambda: |-
      if (id(compressor_active).state) { (id(compressor_minuten) += 1) / 60 ;} 
      else { id(compressor_minuten) /60 ;} 
      int totaal_minuten = id(compressor_minuten);
      int uren = totaal_minuten / 60 + id(offset_uren).state ;
      int minuten = totaal_minuten % 60;
      char buffer[10];
      sprintf(buffer, "%02d:%02d", uren, minuten);
      return {buffer} ;